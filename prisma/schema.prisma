generator client {
  provider      = "prisma-client-py"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------
// ENUM DEFINITIONS
// --------------------
enum UserStatusEnum {
  REGISTERED  // Auth0 login complete, profile incomplete
  PENDING     // Profile complete, Zynk entity created, KYC in progress
  ACTIVE      // KYC approved, fully operational
  SUSPENDED   // Account suspended
  CLOSED      // Account closed
}

enum EntityTypeEnum {
  INDIVIDUAL
  BUSINESS
}

enum KycStatusEnum {
  NOT_STARTED
  INITIATED
  REVIEWING
  ADDITIONAL_INFO_REQUIRED
  REJECTED
  APPROVED
}

enum WebhookEventCategory {
  KYC
  TRANSFER
  WEBHOOK
}

enum WebhookDeliveryStatusEnum {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

enum OtpTypeEnum {
  PHONE_VERIFICATION
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum OtpStatusEnum {
  PENDING
  VERIFIED
  EXPIRED
  FAILED
}

enum AccountStatusEnum {
  INACTIVE
  ACTIVE
}

// --------------------
// MODEL DEFINITIONS
// --------------------

model entities {
  id                String           @id @default(uuid()) @db.Uuid

  // Auth0 identity
  auth0_sub         String           @unique
  email             String           @unique
  email_verified    Boolean?          // optional, from token

  // Profile
  first_name        String?
  last_name         String?
  phone_number      String?
  country_code      String?
  date_of_birth     DateTime?
  nationality       String?

  // Entity / business
  zynk_entity_id    String?           @unique
  entity_type       EntityTypeEnum    @default(INDIVIDUAL)
  status            UserStatusEnum    @default(REGISTERED)

  // Meta
  last_login_at     DateTime?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  deleted_at        DateTime?

  // Relations
  kyc_sessions      kyc_sessions[]
  webhook_events    webhook_events[]
  funding_accounts  funding_accounts[]
  wallets           wallets[]
  externalAccounts  external_accounts[]

  @@map("entities")
}

model kyc_sessions {
  id               String        @id @default(uuid()) @db.Uuid
  entity_id        String        @db.Uuid
  routing_id       String?
  status           KycStatusEnum @default(NOT_STARTED)
  kyc_link         String?
  routing_enabled  Boolean?      @default(false)
  initiated_at     DateTime?
  completed_at     DateTime?
  rejection_reason String?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  deleted_at       DateTime?

  // Relations
  entity         entities         @relation(fields: [entity_id], references: [id])
  webhook_events webhook_events[]

  @@map("kyc_sessions")
}

model webhook_events {
  id             String               @id @default(uuid()) @db.Uuid
  event_category WebhookEventCategory
  event_type     String
  event_status   String?
  entity_id      String?              @db.Uuid
  kyc_session_id String?              @db.Uuid
  teleport_id    String?              @db.Uuid
  event_payload  Json
  created_at     DateTime             @default(now())
  updated_at     DateTime             @updatedAt
  // Relations
  entity         entities?            @relation(fields: [entity_id], references: [id])
  kyc_session    kyc_sessions?        @relation(fields: [kyc_session_id], references: [id])

  @@map("webhook_events")
}

model otp_verifications {
  id           String        @id @default(uuid()) @db.Uuid
  phone_number String? // Optional - for phone verification
  email        String? // Optional - for email verification
  country_code String?       @default("+1")
  otp_code     String
  otp_type     OtpTypeEnum   @default(PHONE_VERIFICATION)
  status       OtpStatusEnum @default(PENDING)
  attempts     Int           @default(0)
  max_attempts Int           @default(3)
  expires_at   DateTime
  verified_at  DateTime?
  ip_address   String? // Track where OTP was requested from
  user_agent   String? // Track device/browser
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  @@index([phone_number, status])
  @@index([email, status])
  @@index([expires_at])
  @@map("otp_verifications")
}


model funding_accounts {
  id                       String            @id @default(uuid()) @db.Uuid
  zynk_funding_account_id  String?           @unique
  entity_id                String            @db.Uuid
  jurisdiction_id          String
  provider_id              String
  status                   AccountStatusEnum @default(INACTIVE)
  currency                 String
  bank_name                String
  bank_address             String
  bank_routing_number      String
  bank_account_number      String
  bank_beneficiary_name    String
  bank_beneficiary_address String
  payment_rail             String
  created_at               DateTime          @default(now())
  updated_at               DateTime          @updatedAt
  deleted_at               DateTime?
  // Relations
  entity                   entities          @relation(fields: [entity_id], references: [id], onDelete: Cascade)

  @@map("funding_accounts")
}

model wallets {
  id               String            @id @default(uuid()) @db.Uuid
  entity_id        String            @db.Uuid
  zynk_wallet_id   String            @unique // Wallet ID from Zynk API (e.g., znc_wallet_...)
  wallet_name      String
  chain            String            // SOLANA, ETHEREUM, etc.
  status           AccountStatusEnum @default(ACTIVE)
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  deleted_at       DateTime?

  // Relations
  entity           entities          @relation(fields: [entity_id], references: [id], onDelete: Cascade)
  wallet_accounts  wallet_accounts[]

  @@index([entity_id])
  @@index([zynk_wallet_id])
  @@map("wallets")
}

model wallet_accounts {
  id              String   @id @default(uuid()) @db.Uuid
  wallet_id       String   @db.Uuid
  curve           String   // CURVE_ED25519, etc.
  path_format     String   // PATH_FORMAT_BIP32, etc.
  path            String   // m/44'/501'/0'/0', etc.
  address_format  String   // ADDRESS_FORMAT_SOLANA, etc.
  address         String   @unique // Blockchain address
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  deleted_at      DateTime?

  // Relations
  wallet          wallets  @relation(fields: [wallet_id], references: [id], onDelete: Cascade)

  @@index([wallet_id])
  @@index([address])
  @@map("wallet_accounts")
  externalAccounts external_accounts[]
}

model external_accounts {
  id                       String            @id @default(uuid()) @db.Uuid
  zynk_external_account_id String            @unique 
  entity_id                String            @db.Uuid
  wallet_account_id        String            @db.Uuid
  wallet_address           String
  jurisdiction_id          String
  status                   AccountStatusEnum @default(INACTIVE)
  created_at               DateTime          @default(now())
  updated_at               DateTime          @updatedAt
  deleted_at               DateTime?
  // Relations
  entity                   entities          @relation(fields: [entity_id], references: [id], onDelete: Cascade)
  wallet_account           wallet_accounts   @relation(fields: [wallet_account_id], references: [id], onDelete: Cascade)

  @@map("external_accounts")
}